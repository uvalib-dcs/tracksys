window.divaPlugins=[];(function($){var Diva=function(element,options){var parentObject=$(element);var defaults={adaptivePadding:0.05,arrowScrollAmount:40,blockMobileMove:false,objectData:"",enableAutoTitle:true,enableFilename:true,enableFullscreen:true,enableGotoPage:true,enableGridIcon:true,enableGridControls:"buttons",enableImageTitles:true,enableKeyScroll:true,enableLinkIcon:true,enableSpaceScroll:false,enableToolbar:true,enableZoomControls:"buttons",fixedPadding:10,fixedHeightGrid:true,goDirectlyTo:0,iipServerURL:"",inFullscreen:false,inBookLayout:false,inGrid:false,imageDir:"",maxPagesPerRow:8,maxZoomLevel:-1,minPagesPerRow:2,minZoomLevel:0,pageLoadTimeout:200,pagesPerRow:5,rowLoadTimeout:50,throbberTimeout:100,tileHeight:256,tileWidth:256,toolbarParentObject:parentObject,verticallyOriented:true,viewportMargin:200,zoomLevel:2};var settings=$.extend({},defaults,options);var globals={allTilesLoaded:[],averageHeights:[],averageWidths:[],currentPageIndex:0,doubleClickZoom:false,documentPaged:false,firstPageLoaded:-1,firstRowLoaded:-1,gridPageWidth:0,hashParamSuffix:"",horizontalOffset:0,horizontalPadding:0,ID:null,initialKeyScroll:false,initialSpaceScroll:false,innerObject:"",isActiveDiva:true,isScrollable:true,isIIIF:false,itemTitle:"",lastPageLoaded:-1,lastRowLoaded:-1,loaded:false,maxWidths:[],maxHeights:[],maxRatio:0,minRatio:0,mobileWebkit:false,numPages:0,numRows:0,oldZoomLevel:-1,outerObject:"",pages:[],pageLeftOffsets:[],pageTopOffsets:[],pageTimeouts:[],pageTools:"",panelHeight:0,panelWidth:0,parentObject:parentObject,plugins:[],previousLeftScroll:0,previousTopScroll:0,realMaxZoom:-1,resizeTimer:-1,rowHeight:0,scaleWait:false,scrollbarWidth:0,selector:"",singleClick:false,singleTap:false,throbberTimeoutID:-1,toolbar:null,totalHeights:[],totalHeight:0,totalWidths:[],totalWidth:0,verticalOffset:0,verticalPadding:0};$.extend(settings,globals);var self=this;var getPageData=function(pageIndex,attribute){return settings.pages[pageIndex].d[settings.zoomLevel][attribute]};var getPageIndex=function(filename){var i,np=settings.numPages;for(i=0;i<np;i++){if(settings.pages[i].f===filename){return i}}return -1};var isHorizontallyInViewport=function(left,right){var leftOfViewport=settings.outerObject.scrollLeft()-settings.viewportMargin;var rightOfViewport=leftOfViewport+settings.panelWidth+settings.viewportMargin*2;var leftVisible=left>=leftOfViewport&&left<=rightOfViewport;var middleVisible=left<=leftOfViewport&&right>=rightOfViewport;var rightVisible=right>=leftOfViewport&&right<=rightOfViewport;return(leftVisible||middleVisible||rightVisible)};var isVerticallyInViewport=function(top,bottom){var topOfViewport=settings.outerObject.scrollTop()-settings.viewportMargin;var bottomOfViewport=topOfViewport+settings.panelHeight+settings.viewportMargin*2;var topVisible=top>=topOfViewport&&top<=bottomOfViewport;var middleVisible=top<=topOfViewport&&bottom>=bottomOfViewport;var bottomVisible=bottom>=topOfViewport&&bottom<=bottomOfViewport;return(topVisible||middleVisible||bottomVisible)};var isTileVisible=function(pageIndex,tileRow,tileCol){var tileTop,tileLeft;if(settings.verticallyOriented){tileTop=settings.pageTopOffsets[pageIndex]+(tileRow*settings.tileHeight)+settings.verticalPadding;tileLeft=settings.pageLeftOffsets[pageIndex]+(tileCol*settings.tileWidth)}else{tileTop=settings.pageTopOffsets[pageIndex]+(tileRow*settings.tileHeight);tileLeft=settings.pageLeftOffsets[pageIndex]+(tileCol*settings.tileWidth)+settings.horizontalPadding}var tileBottom=tileTop+settings.tileHeight;var tileRight=tileLeft+settings.tileWidth;return isVerticallyInViewport(tileTop,tileBottom)&&isHorizontallyInViewport(tileLeft,tileRight)};var isTileLoaded=function(pageIndex,tileIndex){return !!document.getElementById(settings.ID+"tile-"+pageIndex+"-"+tileIndex)};var isPageValid=function(pageIndex){return pageIndex>=0&&pageIndex<settings.numPages};var isPageVisible=function(pageIndex){var topOfPage=settings.pageTopOffsets[pageIndex];var bottomOfPage=topOfPage+getPageData(pageIndex,"h")+settings.verticalPadding;var leftOfPage=settings.pageLeftOffsets[pageIndex];var rightOfPage=leftOfPage+getPageData(pageIndex,"w")+settings.horizontalPadding;return(isVerticallyInViewport(topOfPage,bottomOfPage)&&isHorizontallyInViewport(leftOfPage,rightOfPage))};var isPageLoaded=function(pageIndex){return !!document.getElementById(settings.ID+"page-"+pageIndex)};var loadTiles=function(pageIndex,filename,width,height,pageSelector){var pageElement=document.getElementById(settings.ID+"page-"+pageIndex);if(pageElement===null||!isPageVisible(pageIndex)){return}var imdir=settings.imageDir+"/";var rows=Math.ceil(getPageData(pageIndex,"h")/settings.tileWidth);var cols=Math.ceil(getPageData(pageIndex,"w")/settings.tileHeight);var maxZoom=settings.pages[pageIndex].m;var baseURL=settings.iipServerURL+"?FIF="+imdir+filename+"&JTL=";var allTilesLoaded=true;var tileIndex=0;var lastHeight=height-(rows-1)*settings.tileHeight;var lastWidth=width-(cols-1)*settings.tileWidth;var row,col,tileHeight,tileWidth,top,left,zoomLevel,imageURL,regionHeight,regionWidth,xOffset,yOffset,zoomDifference;zoomLevel=settings.zoomLevel+maxZoom-settings.realMaxZoom;var baseImageURL=(settings.isIIIF)?settings.pages[pageIndex].url:baseURL+zoomLevel+",";var version,quality,iiifSuffix;if(settings.isIIIF){zoomDifference=Math.pow(2,maxZoom-zoomLevel);regionHeight=settings.tileHeight*zoomDifference;regionWidth=settings.tileWidth*zoomDifference;version=settings.pages[pageIndex].api;quality=(version>=2)?"default":"native";iiifSuffix="/0/"+quality+".jpg";if(settings.pages[pageIndex].hasOwnProperty("xoffset")){xOffset=settings.pages[pageIndex].xoffset;yOffset=settings.pages[pageIndex].yoffset}else{xOffset=0;yOffset=0}}else{regionHeight=settings.tileHeight;regionWidth=settings.tileWidth}row=0;while(row<rows){col=0;tileHeight=(row===rows-1)?lastHeight:settings.tileHeight;while(col<cols){top=row*settings.tileHeight;left=col*settings.tileWidth;tileWidth=(col===cols-1)?lastWidth:settings.tileWidth;imageURL=(settings.isIIIF)?baseImageURL+(col*regionWidth+xOffset)+","+(row*regionHeight+yOffset)+","+(tileWidth*zoomDifference)+","+(tileHeight*zoomDifference)+"/"+tileWidth+","+iiifSuffix:baseImageURL+tileIndex;if(!isTileLoaded(pageIndex,tileIndex)){if(isTileVisible(pageIndex,row,col)){var tileElem=document.createElement("div");tileElem.id=settings.ID+"tile-"+pageIndex+"-"+tileIndex;tileElem.classList.add("diva-document-tile");tileElem.style.display="inline";tileElem.style.position="absolute";tileElem.style.top=top+"px";tileElem.style.left=left+"px";tileElem.style.backgroundImage="url('"+imageURL+"')";tileElem.style.height=tileHeight+"px";tileElem.style.width=tileWidth+"px";pageElement.appendChild(tileElem)}else{allTilesLoaded=false}}tileIndex++;col++}row++}settings.allTilesLoaded[pageIndex]=allTilesLoaded;diva.Events.publish("PageDidLoad",[pageIndex,filename,pageSelector],self)};var loadPage=function(pageIndex){if((isPageLoaded(pageIndex)&&settings.allTilesLoaded[pageIndex])||(settings.inBookLayout&&settings.documentPaged&&!settings.pages[pageIndex].paged)){return}var filename=settings.pages[pageIndex].f;var width=getPageData(pageIndex,"w");var height=getPageData(pageIndex,"h");var heightFromTop=settings.pageTopOffsets[pageIndex]+settings.verticalPadding;var widthFromLeft=settings.pageLeftOffsets[pageIndex]+settings.horizontalPadding;var pageSelector=settings.selector+"page-"+pageIndex;var plugin;if(!isPageLoaded(pageIndex)){var innerElement=document.getElementById(settings.ID+"inner");var pageElement=document.createElement("div");pageElement.id=settings.ID+"page-"+pageIndex;pageElement.classList.add("diva-page","diva-document-page");pageElement.setAttribute("data-index",pageIndex);pageElement.setAttribute("data-filename",filename);if(settings.enableImageTitles){pageElement.title="Page "+(pageIndex+1)}pageElement.innerHTML=settings.pageTools;pageElement.style.width=width+"px";pageElement.style.height=height+"px";if(settings.verticallyOriented){pageElement.style.top=heightFromTop+"px";if(settings.inBookLayout){pageElement.style.left=widthFromLeft+"px";if(pageIndex%2){pageElement.classList.add("diva-page-book-left")}else{if(pageIndex===0){var placeholderElement=document.createElement("div");placeholderElement.id=settings.ID+"page-placeholder";placeholderElement.classList.add("diva-page","diva-document-page");placeholderElement.style.width=width+"px";placeholderElement.style.height=height+"px";placeholderElement.style.left=0-width+"px";placeholderElement.style.border="1px solid #ccc";placeholderElement.style.background="#fdfdfd";placeholderElement.style.mozBoxSizing="border-box";placeholderElement.style.webkitBoxSizing="border-box";placeholderElement.style.boxSizing="border-box";pageElement.appendChild(placeholderElement)}pageElement.classList.add("diva-page-book")}}else{pageElement.classList.add("diva-page-vertical")}}else{pageElement.style.left=widthFromLeft+"px";pageElement.classList.add("diva-page-horizontal")}innerElement.appendChild(pageElement);diva.Events.publish("PageWillLoad",[pageIndex,filename,pageSelector],self)}settings.pageTimeouts.push(setTimeout(loadTiles,settings.pageLoadTimeout,pageIndex,filename,width,height))};var deletePage=function(pageIndex){var theNode=document.getElementById(settings.ID+"page-"+pageIndex);if(theNode===null){return}while(theNode.firstChild){theNode.removeChild(theNode.firstChild)}theNode.parentNode.removeChild(theNode)};var pageAboveViewport=function(pageIndex){var bottomOfPage=settings.pageTopOffsets[pageIndex]+getPageData(pageIndex,"h")+settings.verticalPadding;var topOfViewport=document.getElementById(settings.ID+"outer").scrollTop;return bottomOfPage<topOfViewport};var pageBelowViewport=function(pageIndex){var topOfPage=settings.pageTopOffsets[pageIndex];var bottomOfViewport=document.getElementById(settings.ID+"outer").scrollTop+settings.panelHeight;return topOfPage>bottomOfViewport};var pageLeftOfViewport=function(pageIndex){var rightOfPage=settings.pageLeftOffsets[pageIndex]+getPageData(pageIndex,"w")+settings.horizontalPadding;var leftOfViewport=document.getElementById(settings.ID+"outer").scrollLeft;return rightOfPage<leftOfViewport};var pageRightOfViewport=function(pageIndex){var leftOfPage=settings.pageLeftOffsets[pageIndex];var rightOfViewport=document.getElementById(settings.ID+"outer").scrollLeft+settings.panelWidth;return leftOfPage>rightOfViewport};var pageBeforeViewport=function(pageIndex){return(settings.verticallyOriented?pageAboveViewport(pageIndex):pageLeftOfViewport(pageIndex))};var pageAfterViewport=function(pageIndex){return(settings.verticallyOriented?pageBelowViewport(pageIndex):pageRightOfViewport(pageIndex))};var attemptPageShow=function(pageIndex,direction){if(isPageValid(pageIndex)){if(direction>0){if(isPageVisible(pageIndex)){loadPage(pageIndex);settings.lastPageLoaded=pageIndex;attemptPageShow(settings.lastPageLoaded+1,direction)}else{if(isPageValid(pageIndex+1)&&isPageVisible(pageIndex+1)){loadPage(pageIndex+1);settings.lastPageLoaded=pageIndex+1;attemptPageShow(settings.lastPageLoaded+1,direction)}else{if(pageBeforeViewport(pageIndex)){attemptPageShow(pageIndex+1,direction)}}}}else{if(isPageVisible(pageIndex)){loadPage(pageIndex);settings.firstPageLoaded=pageIndex;attemptPageShow(settings.firstPageLoaded-1,direction)}else{if(isPageValid(pageIndex-1)&&isPageVisible(pageIndex-1)){loadPage(pageIndex-1);settings.firstPageLoaded=pageIndex-1;attemptPageShow(settings.firstPageLoaded-1,direction)}else{if(pageAfterViewport(pageIndex)){attemptPageShow(pageIndex-1,direction)}}}}}};var attemptPageHide=function(pageIndex,direction){if(direction>0){if(isPageValid(pageIndex)&&pageBeforeViewport(pageIndex)){deletePage(pageIndex);settings.firstPageLoaded=pageIndex+1;attemptPageHide(settings.firstPageLoaded,direction)}}else{if(isPageValid(pageIndex)&&pageAfterViewport(pageIndex)){deletePage(pageIndex);settings.lastPageLoaded=pageIndex-1;attemptPageHide(settings.lastPageLoaded,direction)}}};var adjustPages=function(direction){var i;if(direction<0){attemptPageShow(settings.lastPageLoaded,direction);setCurrentPage(-1);attemptPageHide(settings.lastPageLoaded,direction)}else{if(direction>0){attemptPageShow(settings.firstPageLoaded,direction);setCurrentPage(1);attemptPageHide(settings.firstPageLoaded,direction)}else{if(settings.inBookLayout){setCurrentPage(0)}var lpl=settings.lastPageLoaded;for(i=Math.max(settings.firstPageLoaded,0);i<=lpl;i++){if(isPageVisible(i)){loadPage(i)}}}}var scrollSoFar=(settings.verticallyOriented?document.getElementById(settings.ID+"outer").scrollTop:document.getElementById(settings.ID+"outer").scrollLeft);diva.Events.publish("ViewerDidScroll",[scrollSoFar],self);if(direction>0){diva.Events.publish("ViewerDidScrollDown",[scrollSoFar],self)}else{if(direction<0){diva.Events.publish("ViewerDidScrollUp",[scrollSoFar],self)}}};var isRowValid=function(rowIndex){return rowIndex>=0&&rowIndex<settings.numRows};var isRowVisible=function(rowIndex){var topOfRow=settings.rowHeight*rowIndex;var bottomOfRow=topOfRow+settings.rowHeight+settings.fixedPadding;return isVerticallyInViewport(topOfRow,bottomOfRow)};var isRowLoaded=function(rowIndex){return !!document.getElementById(settings.ID+"row-"+rowIndex)};var loadRow=function(rowIndex){if(isRowLoaded(rowIndex)){return}var heightFromTop=(settings.rowHeight*rowIndex)+settings.fixedPadding;var innerElem=document.getElementById(settings.ID+"inner");var rowDiv=document.createElement("div");rowDiv.id=settings.ID+"row-"+rowIndex;rowDiv.classList.add("diva-row");rowDiv.style.height=settings.rowHeight+"px";rowDiv.style.top=heightFromTop+"px";innerElem.appendChild(rowDiv);var i,pageIndex,filename,realWidth,realHeight,pageWidth,pageHeight,leftOffset,imageURL,version,quality,iiifSuffix;var imdir=settings.imageDir+"/";var ppr=settings.pagesPerRow;for(i=0;i<ppr;i++){pageIndex=rowIndex*settings.pagesPerRow+i;if(!isPageValid(pageIndex)){break}filename=settings.pages[pageIndex].f;realWidth=getPageData(pageIndex,"w");realHeight=getPageData(pageIndex,"h");pageWidth=(settings.fixedHeightGrid)?(settings.rowHeight-settings.fixedPadding)*realWidth/realHeight:settings.gridPageWidth;pageHeight=(settings.fixedHeightGrid)?settings.rowHeight-settings.fixedPadding:pageWidth/realWidth*realHeight;leftOffset=parseInt(i*(settings.fixedPadding+settings.gridPageWidth)+settings.fixedPadding,10);version=settings.pages[pageIndex].api;quality=(version>=2)?"default":"native";iiifSuffix=",/0/"+quality+".jpg";pageWidth=parseInt(pageWidth,10);pageHeight=parseInt(pageHeight,10);leftOffset+=(settings.fixedHeightGrid)?(settings.gridPageWidth-pageWidth)/2:0;imageURL=(settings.isIIIF)?encodeURI(settings.pages[pageIndex].url+"full/"+pageWidth+iiifSuffix):encodeURI(settings.iipServerURL+"?FIF="+imdir+filename+"&HEI="+(pageHeight+2)+"&CVT=JPEG");settings.pageTopOffsets[pageIndex]=heightFromTop;settings.pageLeftOffsets[pageIndex]=leftOffset;var pageDiv=document.createElement("div");pageDiv.id=settings.ID+"page-"+pageIndex;var pageSelector=settings.selector+"page-"+pageIndex;pageDiv.classList.add("diva-page","diva-grid-page");pageDiv.style.width=pageWidth+"px";pageDiv.style.height=pageHeight+"px";pageDiv.style.left=leftOffset+"px";pageDiv.setAttribute("data-index",pageIndex);pageDiv.setAttribute("data-filename",filename);if(settings.enableImageTitles){pageDiv.title="Page "+(pageIndex+1)}rowDiv.appendChild(pageDiv);diva.Events.publish("PageWillLoad",[pageIndex,filename,pageSelector],self);addPageToQueue(rowIndex,pageIndex,imageURL,pageWidth,pageHeight)}};var deleteRow=function(rowIndex){var theNode=document.getElementById(settings.ID+"row-"+rowIndex);if(theNode===null){return}while(theNode.firstChild){theNode.removeChild(theNode.firstChild)}theNode.parentNode.removeChild(theNode)};var rowAboveViewport=function(rowIndex){var bottomOfRow=settings.rowHeight*(rowIndex+1);var topOfViewport=document.getElementById(settings.ID+"outer").scrollTop;return(bottomOfRow<topOfViewport)};var rowBelowViewport=function(rowIndex){var topOfRow=settings.rowHeight*rowIndex;var bottomOfViewport=document.getElementById(settings.ID+"outer").scrollTop+settings.panelHeight;return(topOfRow>bottomOfViewport)};var attemptRowShow=function(rowIndex,direction){if(direction>0){if(isRowValid(rowIndex)){if(isRowVisible(rowIndex)){loadRow(rowIndex);settings.lastRowLoaded=rowIndex;attemptRowShow(settings.lastRowLoaded+1,direction)}else{if(rowAboveViewport(rowIndex)){attemptRowShow(rowIndex+1,direction)}}}}else{if(isRowValid(rowIndex)){if(isRowVisible(rowIndex)){loadRow(rowIndex);settings.firstRowLoaded=rowIndex;attemptRowShow(settings.firstRowLoaded-1,direction)}else{if(rowBelowViewport(rowIndex)){attemptRowShow(rowIndex-1,direction)}}}}};var attemptRowHide=function(rowIndex,direction){if(direction>0){if(isRowValid(rowIndex)&&rowAboveViewport(rowIndex)){deleteRow(rowIndex);settings.firstRowLoaded++;attemptRowHide(settings.firstRowLoaded,direction)}}else{if(isRowValid(rowIndex)&&rowBelowViewport(rowIndex)){deleteRow(rowIndex);settings.lastRowLoaded--;attemptRowHide(settings.lastRowLoaded,direction)}}};var adjustRows=function(direction){if(direction<0){attemptRowShow(settings.firstRowLoaded,-1);setCurrentRow(-1);attemptRowHide(settings.lastRowLoaded,-1)}else{if(direction>0){attemptRowShow(settings.lastRowLoaded,1);setCurrentRow(1);attemptRowHide(settings.firstRowLoaded,1)}}var newTopScroll=document.getElementById(settings.ID+"outer").scrollTop;diva.Events.publish("ViewerDidScroll",[newTopScroll],self);if(direction>0){diva.Events.publish("ViewerDidScrollDown",[newTopScroll],self)}else{if(direction<0){diva.Events.publish("ViewerDidScrollUp",[newTopScroll],self)}}};var addPageToQueue=function(rowIndex,pageIndex,imageURL,pageWidth,pageHeight){var loadFunction=function(rowIndex,pageIndex,imageURL,pageWidth,pageHeight){if(isPageLoaded(pageIndex)){var imgEl=document.createElement("img");imgEl.src=imageURL;imgEl.style.width=pageWidth+"px";imgEl.style.height=pageHeight+"px";document.getElementById(settings.ID+"page-"+pageIndex).appendChild(imgEl)}};settings.pageTimeouts.push(window.setTimeout(loadFunction,settings.rowLoadTimeout,rowIndex,pageIndex,imageURL,pageWidth,pageHeight))};var getClosestVisiblePage=function(pageIndex,direction){var totalPages=settings.numPages;if(settings.documentPaged&&settings.inBookLayout){while(pageIndex>0&&pageIndex<totalPages){if(settings.pages[pageIndex].paged){return pageIndex}pageIndex+=direction}}return pageIndex};var setCurrentPage=function(direction){var currentPage=settings.currentPageIndex;var pageToConsider=currentPage+direction;pageToConsider=getClosestVisiblePage(pageToConsider,direction);if(!isPageValid(pageToConsider)){return false}var middleOfViewport=(settings.verticallyOriented?document.getElementById(settings.ID+"outer").scrollTop+(settings.panelHeight/2):document.getElementById(settings.ID+"outer").scrollLeft+(settings.panelWidth/2));var verticalMiddleOfViewport=document.getElementById(settings.ID+"outer").scrollLeft+(settings.panelWidth/2);var changeCurrentPage=false;if(direction<0){if(settings.verticallyOriented){if(pageToConsider>=0&&(settings.pageTopOffsets[pageToConsider]+getPageData(pageToConsider,"h")+(settings.verticalPadding)>=middleOfViewport)){changeCurrentPage=true}}else{if(pageToConsider>=0&&(settings.pageLeftOffsets[pageToConsider]+getPageData(pageToConsider,"w")+(settings.horizontalPadding)>=middleOfViewport)){changeCurrentPage=true}}}else{if(direction>0){if(settings.verticallyOriented){if(settings.pageTopOffsets[currentPage]+getPageData(currentPage,"h")+settings.verticalPadding<middleOfViewport){changeCurrentPage=true}}else{if(settings.pageLeftOffsets[currentPage]+getPageData(currentPage,"w")+settings.horizontalPadding<middleOfViewport){changeCurrentPage=true}}}}if(settings.inBookLayout&&settings.verticallyOriented){var isScrolledToRight=verticalMiddleOfViewport>settings.maxWidths[settings.zoomLevel];var bookDirection=(isScrolledToRight)?1:-1;var bookPageToConsider=currentPage+bookDirection;var isValidPagePosition;bookPageToConsider=getClosestVisiblePage(bookPageToConsider,bookDirection);if(isScrolledToRight){isValidPagePosition=settings.pageLeftOffsets[bookPageToConsider]>=(settings.maxWidths[settings.zoomLevel]/2)}else{isValidPagePosition=settings.pageLeftOffsets[bookPageToConsider]<(settings.maxWidths[settings.zoomLevel]/2)}if(isValidPagePosition&&bookPageToConsider!==settings.currentPageIndex){settings.currentPageIndex=bookPageToConsider;diva.Events.publish("VisiblePageDidChange",[bookPageToConsider,settings.pages[bookPageToConsider].f],self)}}if(changeCurrentPage){settings.currentPageIndex=pageToConsider;if(direction!==0){if(!setCurrentPage(direction)){var filename=settings.pages[pageToConsider].f;diva.Events.publish("VisiblePageDidChange",[pageToConsider,filename],self)}}return true}return false};var setCurrentRow=function(direction){var currentRow=Math.floor(settings.currentPageIndex/settings.pagesPerRow);var rowToConsider=currentRow+parseInt(direction,10);var topScroll=document.getElementById(settings.ID+"outer").scrollTop;var middleOfViewport=topScroll+(settings.panelHeight/2);var changeCurrentRow=false;if(direction<0){if(rowToConsider>=0&&(settings.rowHeight*currentRow>=middleOfViewport||settings.rowHeight*rowToConsider>=topScroll)){changeCurrentRow=true}}else{if(direction>0){if((settings.rowHeight*(currentRow+1))<topScroll&&isRowValid(rowToConsider)){changeCurrentRow=true}}}if(changeCurrentRow){settings.currentPageIndex=rowToConsider*settings.pagesPerRow;if(direction!==0){if(!setCurrentRow(direction)){var pageIndex=settings.currentPageIndex;var filename=settings.pages[pageIndex].f;diva.Events.publish("VisiblePageDidChange",[pageIndex,filename],self)}}return true}return false};var gotoPageTop=function(pageIndex){var verticalOffset=getYOffset(pageIndex,"top");var horizontalOffset=getXOffset(pageIndex,"center");gotoPage(pageIndex,verticalOffset,horizontalOffset)};var gotoPage=function(pageIndex,verticalOffset,horizontalOffset){horizontalOffset=(typeof horizontalOffset!=="undefined")?horizontalOffset:0;verticalOffset=(typeof verticalOffset!=="undefined")?verticalOffset:0;var desiredVerticalCenter=settings.pageTopOffsets[pageIndex]+verticalOffset;var desiredTop=desiredVerticalCenter-parseInt(settings.panelHeight/2,10);var desiredHorizontalCenter=settings.pageLeftOffsets[pageIndex]+horizontalOffset;var desiredLeft=desiredHorizontalCenter-parseInt(settings.panelWidth/2,10);settings.outerObject.scrollTop(desiredTop);settings.outerObject.scrollLeft(desiredLeft);if(pageIndex!==settings.currentPageIndex){settings.currentPageIndex=pageIndex;var filename=settings.pages[pageIndex].f;diva.Events.publish("VisiblePageDidChange",[pageIndex,filename],self)}diva.Events.publish("ViewerDidJump",[pageIndex],self)};var gotoRow=function(pageIndex){var desiredRow=Math.floor(pageIndex/settings.pagesPerRow);var desiredTop=desiredRow*settings.rowHeight;settings.outerObject.scrollTop(desiredTop);settings.currentPageIndex=pageIndex;var filename=settings.pages[pageIndex].f;diva.Events.publish("VisiblePageDidChange",[pageIndex,filename],self)};var gridScroll=function(){gotoRow(settings.goDirectlyTo)};var getValidZoomLevel=function(zoomLevel){return(zoomLevel>=settings.minZoomLevel&&zoomLevel<=settings.maxZoomLevel)?zoomLevel:settings.minZoomLevel};var getValidPagesPerRow=function(pagesPerRow){return(pagesPerRow>=settings.minPagesPerRow&&pagesPerRow<=settings.maxPagesPerRow)?pagesPerRow:settings.maxPagesPerRow};var clearViewer=function(){settings.allTilesLoaded=[];settings.outerObject.scrollTop(0);settings.innerObject.empty();settings.firstPageLoaded=0;settings.firstRowLoaded=-1;settings.previousTopScroll=0;settings.previousLeftScroll=0;clearTimeout(settings.resizeTimer);while(settings.pageTimeouts.length){clearTimeout(settings.pageTimeouts.pop())}};var loadViewer=function(){if(settings.inGrid){loadGrid()}else{loadDocument()}};var calculatePageOffsets=function(widthToSet,heightToSet){var heightSoFar=0;var widthSoFar=0;var i;settings.pageTopOffsets=[];settings.pageLeftOffsets=[];if(settings.inBookLayout){var isLeft=false;if(settings.verticallyOriented){for(i=0;i<settings.numPages;i++){settings.pageTopOffsets[i]=heightSoFar;if(isLeft){settings.pageLeftOffsets[i]=(widthToSet/2)-getPageData(i,"w")-settings.horizontalPadding}else{settings.pageLeftOffsets[i]=(widthToSet/2)-settings.horizontalPadding;if(!settings.documentPaged||settings.pages[i].paged){var pageHeight=(isPageValid(i-1))?Math.max(getPageData(i,"h"),getPageData(i-1,"h")):getPageData(i,"h");heightSoFar=settings.pageTopOffsets[i]+pageHeight+settings.verticalPadding}}if(!settings.documentPaged||settings.pages[i].paged){isLeft=!isLeft}}}else{for(i=0;i<settings.numPages;i++){settings.pageTopOffsets[i]=parseInt((heightToSet-getPageData(i,"h"))/2,10);settings.pageLeftOffsets[i]=widthSoFar;var pageWidth=getPageData(i,"w");var padding=(isLeft)?0:settings.horizontalPadding;widthSoFar=settings.pageLeftOffsets[i]+pageWidth+padding;if(!settings.documentPaged||settings.pages[i].paged){isLeft=!isLeft}}}}else{for(i=0;i<settings.numPages;i++){settings.pageTopOffsets[i]=parseInt(settings.verticallyOriented?heightSoFar:(heightToSet-getPageData(i,"h"))/2,10);settings.pageLeftOffsets[i]=parseInt(settings.verticallyOriented?(widthToSet-getPageData(i,"w"))/2:widthSoFar,10);heightSoFar=settings.pageTopOffsets[i]+getPageData(i,"h")+settings.verticalPadding;widthSoFar=settings.pageLeftOffsets[i]+getPageData(i,"w")+settings.horizontalPadding}}};var loadDocument=function(){clearViewer();settings.zoomLevel=getValidZoomLevel(settings.zoomLevel);var z=settings.zoomLevel;settings.totalHeight=settings.totalHeights[z]+settings.verticalPadding*(settings.numPages+1);settings.totalWidth=settings.totalWidths[z]+settings.horizontalPadding*(settings.numPages+1);var maxWidthToSet=(settings.inBookLayout)?(settings.maxWidths[z]+settings.horizontalPadding)*2:settings.maxWidths[z]+settings.horizontalPadding*2;var maxHeightToSet=settings.maxHeights[z]+settings.verticalPadding*2;var widthToSet=Math.max(maxWidthToSet,settings.panelWidth);var heightToSet=Math.max(maxHeightToSet,settings.panelHeight);var innerEl=document.getElementById(settings.ID+"inner");if(settings.verticallyOriented){innerEl.style.height=Math.round(settings.totalHeight)+"px";innerEl.style.width=Math.round(widthToSet)+"px"}else{innerEl.style.height=Math.round(heightToSet)+"px";innerEl.style.width=Math.round(settings.totalWidth)+"px"}calculatePageOffsets(widthToSet,heightToSet);var lastPageIndex=settings.numPages-1;if(settings.inBookLayout){if(settings.verticallyOriented){var lastOpeningHeight=(lastPageIndex%2||lastPageIndex===0)?getPageData(lastPageIndex,"h"):Math.max(getPageData(lastPageIndex,"h"),getPageData(lastPageIndex-1,"h"));innerEl.style.height=settings.pageTopOffsets[lastPageIndex]+lastOpeningHeight+(settings.verticalPadding*2)+"px"}else{innerEl.style.width=settings.pageLeftOffsets[lastPageIndex]+getPageData(lastPageIndex,"w")+(settings.horizontalPadding*2)+"px"}}if(!isPageValid(settings.goDirectlyTo)){settings.goDirectlyTo=0}gotoPage(settings.goDirectlyTo,settings.verticalOffset,settings.horizontalOffset);var pageBlockFound=false;for(var i=0;i<settings.numPages;i++){if(isPageVisible(i)){loadPage(i);settings.lastPageLoaded=i;pageBlockFound=true}else{if(pageBlockFound){break}}}if(settings.oldZoomLevel>=0){if(settings.oldZoomLevel<settings.zoomLevel){diva.Events.publish("ViewerDidZoomIn",[z],self)}else{diva.Events.publish("ViewerDidZoomOut",[z],self)}diva.Events.publish("ViewerDidZoom",[z],self)}else{settings.oldZoomLevel=settings.zoomLevel}if(settings.scaleWait){settings.scaleWait=false}var fileName=settings.pages[settings.currentPageIndex].f;diva.Events.publish("DocumentDidLoad",[settings.currentPageIndex,fileName],self)};var loadGrid=function(){var pageIndex=settings.currentPageIndex;settings.verticalOffset=(settings.verticallyOriented?(settings.panelHeight/2):getPageData(pageIndex,"h")/2);settings.horizontalOffset=(settings.verticallyOriented?getPageData(pageIndex,"w")/2:(settings.panelWidth/2));clearViewer();settings.pagesPerRow=getValidPagesPerRow(settings.pagesPerRow);var horizontalPadding=settings.fixedPadding*(settings.pagesPerRow+1);var pageWidth=(settings.panelWidth-horizontalPadding)/settings.pagesPerRow;settings.gridPageWidth=pageWidth;settings.rowHeight=(settings.fixedHeightGrid)?settings.fixedPadding+settings.minRatio*pageWidth:settings.fixedPadding+settings.maxRatio*pageWidth;settings.numRows=Math.ceil(settings.numPages/settings.pagesPerRow);settings.totalHeight=settings.numRows*settings.rowHeight+settings.fixedPadding;var innerEl=document.getElementById(settings.ID+"inner");innerEl.style.height=Math.round(settings.totalHeight)+"px";innerEl.style.width=Math.round(settings.panelWidth)+"px";gridScroll();var i,rowIndex;settings.pageTopOffsets=[];settings.pageLeftOffsets=[];var np=settings.numPages;for(i=0;i<np;i+=settings.pagesPerRow){rowIndex=Math.floor(i/settings.pagesPerRow);if(isRowVisible(rowIndex)){settings.firstRowLoaded=(settings.firstRowLoaded<0)?rowIndex:settings.firstRowLoaded;loadRow(rowIndex);settings.lastRowLoaded=rowIndex}}};var escapeListener=function(e){if(e.keyCode==27){toggleFullscreen()}};var handleModeChange=function(changeView){settings.outerObject.toggleClass("diva-fullscreen");$("body").toggleClass("diva-hide-scrollbar");settings.parentObject.toggleClass("diva-full-width");var storedHeight=settings.panelHeight;var storedWidth=settings.panelWidth;updatePanelSize();if(settings.oldZoomLevel>=0&&!settings.inGrid){var newHeight=settings.panelHeight;var newWidth=settings.panelWidth;if(settings.inFullscreen){settings.verticalOffset-=((newHeight-storedHeight)/2);settings.horizontalOffset-=((newWidth-storedWidth)/2)}else{settings.verticalOffset+=((storedHeight-newHeight)/2);settings.horizontalOffset+=((storedWidth-newWidth)/2)}}if(changeView){settings.inGrid=!settings.inGrid;handleViewChange()}else{loadViewer()}if(settings.inFullscreen){$(document).on("keyup",escapeListener)}else{$(document).off("keyup",escapeListener)}diva.Events.publish("ModeDidSwitch",[settings.inFullscreen],self)};var handleViewChange=function(){loadViewer();diva.Events.publish("ViewDidSwitch",[settings.inGrid],self);return true};var toggleFullscreen=function(){settings.goDirectlyTo=settings.currentPageIndex;settings.inFullscreen=!settings.inFullscreen;handleModeChange(false)};var changeView=function(destinationView){settings.goDirectlyTo=settings.currentPageIndex;switch(destinationView){case"document":settings.inGrid=false;settings.inBookLayout=false;break;case"book":settings.inGrid=false;settings.inBookLayout=true;break;case"grid":settings.inGrid=true;break;default:return false}return handleViewChange()};var toggleOrientation=function(){settings.verticallyOriented=!settings.verticallyOriented;settings.verticalOffset=getYOffset();settings.horizontalOffset=getXOffset();settings.goDirectlyTo=settings.currentPageIndex;if(settings.inGrid){settings.inGrid=false;handleViewChange()}else{loadDocument()}return settings.verticallyOriented};var handleDocumentDoubleClick=function(event){var pageOffset=$(this).offset();settings.doubleClickZoom=true;settings.horizontalOffset=event.pageX-pageOffset.left;settings.verticalOffset=event.pageY-pageOffset.top;settings.goDirectlyTo=parseInt($(this).attr("data-index"),10);var newZoomLevel=(event.ctrlKey)?settings.zoomLevel-1:settings.zoomLevel+1;handleZoom(newZoomLevel)};var handleGridDoubleClick=function(event){var pageIndex=parseInt($(this).attr("data-index"),10);settings.goDirectlyTo=pageIndex;var pageOffset=$(this).offset();var zoomProportion=getPageData(pageIndex,"w")/$(this).width();settings.horizontalOffset=(event.pageX-pageOffset.left)*zoomProportion;settings.verticalOffset=(event.pageY-pageOffset.top)*zoomProportion;settings.inGrid=false;handleViewChange()};var handlePinchZoom=function(zoomDelta,event){var newZoomLevel=settings.zoomLevel;if(zoomDelta>100&&newZoomLevel<settings.maxZoomLevel){newZoomLevel++}else{if(zoomDelta<-100&&newZoomLevel>settings.minZoomLevel){newZoomLevel--}else{return}}settings.scaleWait=true;var pageOffset=$(this).offset();settings.horizontalOffset=event.pageX-pageOffset.left;settings.verticalOffset=event.pageY-pageOffset.top;settings.goDirectlyTo=parseInt($(this).attr("data-index"),10);handleZoom(newZoomLevel)};var handleZoom=function(newValue){var newZoomLevel=getValidZoomLevel(newValue);if(newZoomLevel!==newValue){return false}var zoomRatio=Math.pow(2,newZoomLevel-settings.zoomLevel);if(settings.doubleClickZoom){settings.verticalOffset*=zoomRatio;settings.horizontalOffset*=zoomRatio;settings.doubleClickZoom=false}else{settings.goDirectlyTo=settings.currentPageIndex;settings.verticalOffset=zoomRatio*getCurrentYOffset();settings.horizontalOffset=zoomRatio*getCurrentXOffset()}settings.oldZoomLevel=settings.zoomLevel;settings.zoomLevel=newZoomLevel;diva.Events.publish("ZoomLevelDidChange",[newZoomLevel],self);loadDocument();return true};var handleGrid=function(newValue){var newPagesPerRow=getValidPagesPerRow(newValue);if(newPagesPerRow!==newValue){return false}settings.pagesPerRow=newPagesPerRow;diva.Events.publish("GridRowNumberDidChange",[newPagesPerRow],self);settings.goDirectlyTo=settings.currentPageIndex;loadGrid();return true};var getYOffset=function(pageIndex,anchor){pageIndex=(typeof(pageIndex)==="undefined"?settings.currentPageIndex:pageIndex);if(anchor==="center"||anchor==="centre"){return parseInt(getPageData(pageIndex,"h")/2,10)}else{if(anchor==="bottom"){return parseInt(getPageData(pageIndex,"h")-settings.panelHeight/2,10)}else{return parseInt(settings.panelHeight/2,10)}}};var getXOffset=function(pageIndex,anchor){pageIndex=(typeof(pageIndex)==="undefined"?settings.currentPageIndex:pageIndex);if(anchor==="left"){return parseInt(settings.panelWidth/2,10)}else{if(anchor==="right"){return parseInt(getPageData(pageIndex,"w")-settings.panelWidth/2,10)}else{return parseInt(getPageData(pageIndex,"w")/2,10)}}};var getCurrentYOffset=function(){var scrollTop=document.getElementById(settings.ID+"outer").scrollTop;var elementHeight=settings.panelHeight;return(scrollTop-settings.pageTopOffsets[settings.currentPageIndex]+parseInt(elementHeight/2,10))};var getCurrentXOffset=function(){var scrollLeft=document.getElementById(settings.ID+"outer").scrollLeft;var elementWidth=settings.panelWidth;return(scrollLeft-settings.pageLeftOffsets[settings.currentPageIndex]+parseInt(elementWidth/2,10))};var getState=function(){var view;if(settings.inGrid){view="g"}else{if(settings.inBookLayout){view="b"}else{view="d"}}var state={f:settings.inFullscreen,v:view,z:settings.zoomLevel,n:settings.pagesPerRow,i:(settings.enableFilename)?settings.pages[settings.currentPageIndex].f:false,p:(settings.enableFilename)?false:settings.currentPageIndex+1,y:(settings.inGrid)?false:getCurrentYOffset(),x:(settings.inGrid)?false:getCurrentXOffset()};return state};var getURLHash=function(){var hashParams=getState();var hashStringBuilder=[];var param;for(param in hashParams){if(hashParams[param]!==false){hashStringBuilder.push(param+settings.hashParamSuffix+"="+encodeURIComponent(hashParams[param]))}}return hashStringBuilder.join("&")};var getCurrentURL=function(){return location.protocol+"//"+location.host+location.pathname+location.search+"#"+getURLHash()};var updatePanelSize=function(){var outerElem=document.getElementById(settings.ID+"outer");settings.panelHeight=outerElem.clientHeight-(outerElem.scrollWidth>outerElem.clientWidth?settings.scrollbarWidth:0);settings.panelWidth=outerElem.clientWidth-(outerElem.scrollHeight>outerElem.clientHeight?settings.scrollbarWidth:0);settings.horizontalOffset=getCurrentXOffset();settings.verticalOffset=getCurrentYOffset();gotoPage(settings.currentPageIndex,settings.verticalOffset,settings.horizontalOffset);return true};var bindMouseEvents=function(){settings.outerObject.dragscrollable({dragSelector:".diva-dragger",acceptPropagatedEvent:true});settings.innerObject.dragscrollable({dragSelector:".diva-dragger",acceptPropagatedEvent:true});settings.outerObject.on("dblclick",".diva-document-page",function(event){handleDocumentDoubleClick.call(this,event)});settings.outerObject.on("contextmenu",".diva-document-page",function(event){if(event.ctrlKey){clearTimeout(settings.singleClickTimeout);if(settings.singleClick){handleDocumentDoubleClick.call(this,event);settings.singleClick=false}else{settings.singleClick=true;settings.singleClickTimeout=setTimeout(function(){settings.singleClick=false},500)}return false}});settings.outerObject.on("dblclick",".diva-row",function(event){handleGridDoubleClick.call($(event.target).parent(),event)})};var onResize=function(){updatePanelSize();clearTimeout(settings.resizeTimer);settings.resizeTimer=setTimeout(function(){settings.goDirectlyTo=settings.currentPageIndex;settings.verticalOffset=getCurrentYOffset();settings.horizontalOffset=getCurrentXOffset();loadViewer()},200)};var bindTouchEvents=function(){if(settings.blockMobileMove){$("body").bind("touchmove",function(event){var e=event.originalEvent;e.preventDefault();return false})}settings.outerObject.kinetic({triggerHardware:true});var start=[],move=[],startDistance=0;settings.outerObject.on("touchstart",".diva-document-page",function(event){event.preventDefault();if(event.originalEvent.touches.length===2){start=[event.originalEvent.touches[0].clientX,event.originalEvent.touches[0].clientY,event.originalEvent.touches[1].clientX,event.originalEvent.touches[1].clientY];startDistance=distance(start[2],start[0],start[3],start[1])}});settings.outerObject.on("touchmove",".diva-document-page",function(event){event.preventDefault();if(event.originalEvent.touches.length===2){move=[event.originalEvent.touches[0].clientX,event.originalEvent.touches[0].clientY,event.originalEvent.touches[1].clientX,event.originalEvent.touches[1].clientY];var moveDistance=distance(move[2],move[0],move[3],move[1]);var zoomDelta=moveDistance-startDistance;if(!settings.scaleWait){settings.goDirectlyTo=settings.currentPageIndex;if(settings.inGrid){settings.inGrid=false;handleViewChange()}else{handlePinchZoom.call(this,zoomDelta,event)}}}});var firstTapCoordinates={},tapDistance=0;var onDoubleTap=function(event){event.preventDefault();if(settings.singleTap){var touchEvent={pageX:event.originalEvent.changedTouches[0].clientX,pageY:event.originalEvent.changedTouches[0].clientY};tapDistance=distance(firstTapCoordinates.pageX,touchEvent.pageX,firstTapCoordinates.pageY,touchEvent.pageY);if(tapDistance<50&&settings.zoomLevel<settings.maxZoomLevel){if(settings.inGrid){handleGridDoubleClick.call($(event.target).parent(),touchEvent)}else{handleDocumentDoubleClick.call(this,touchEvent)}}settings.singleTap=false;firstTapCoordinates={}}else{settings.singleTap=true;firstTapCoordinates.pageX=event.originalEvent.changedTouches[0].clientX;firstTapCoordinates.pageY=event.originalEvent.changedTouches[0].clientY;settings.singleTapTimeout=setTimeout(function(){settings.singleTap=false;firstTapCoordinates={}},250)}};settings.outerObject.on("touchend",".diva-page",onDoubleTap)};var distance=function(x2,x1,y2,y1){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))};var handleEvents=function(){settings.innerObject.mouseover(function(){$(this).removeClass("diva-grabbing").addClass("diva-grab")});settings.innerObject.mouseout(function(){$(this).removeClass("diva-grab")});settings.innerObject.mousedown(function(){$(this).removeClass("diva-grab").addClass("diva-grabbing")});settings.innerObject.mouseup(function(){$(this).removeClass("diva-grabbing").addClass("diva-grab")});bindMouseEvents();var scrollFunction=function(){var direction;var newScrollTop=document.getElementById(settings.ID+"outer").scrollTop;var newScrollLeft=document.getElementById(settings.ID+"outer").scrollLeft;if(settings.verticallyOriented||settings.inGrid){direction=newScrollTop-settings.previousTopScroll}else{direction=newScrollLeft-settings.previousLeftScroll}if(settings.inGrid){adjustRows(direction)}else{adjustPages(direction)}settings.previousTopScroll=newScrollTop;settings.previousLeftScroll=newScrollLeft;settings.horizontalOffset=getCurrentXOffset();settings.verticalOffset=getCurrentYOffset()};settings.outerObject.scroll(scrollFunction);var upArrowKey=38,downArrowKey=40,leftArrowKey=37,rightArrowKey=39,spaceKey=32,pageUpKey=33,pageDownKey=34,homeKey=36,endKey=35;$(document).on("keydown.diva",function(event){if(!settings.isActiveDiva){return true}if((settings.enableSpaceScroll&&!event.shiftKey&&event.keyCode===spaceKey)||(settings.enableKeyScroll&&event.keyCode===pageDownKey)){settings.outerObject.scrollTop(document.getElementById(settings.ID+"outer").scrollTop+settings.panelHeight);return false}else{if(!settings.enableSpaceScroll&&event.keyCode===spaceKey){event.preventDefault()}}if(settings.enableKeyScroll){if(event.shiftKey||event.ctrlKey||event.metaKey){return true}switch(event.keyCode){case pageUpKey:settings.outerObject.scrollTop(document.getElementById(settings.ID+"outer").scrollTop-settings.panelHeight);return false;case upArrowKey:settings.outerObject.scrollTop(document.getElementById(settings.ID+"outer").scrollTop-settings.arrowScrollAmount);return false;case downArrowKey:settings.outerObject.scrollTop(document.getElementById(settings.ID+"outer").scrollTop+settings.arrowScrollAmount);return false;case leftArrowKey:settings.outerObject.scrollLeft(document.getElementById(settings.ID+"outer").scrollLeft-settings.arrowScrollAmount);return false;case rightArrowKey:settings.outerObject.scrollLeft(document.getElementById(settings.ID+"outer").scrollLeft+settings.arrowScrollAmount);return false;case homeKey:settings.outerObject.scrollTop(0);return false;case endKey:settings.outerObject.scrollTop(settings.totalHeight);return false;default:return true}}return true});diva.Events.subscribe("ViewerDidTerminate",function(){$(document).off("keydown.diva")},settings.ID);bindTouchEvents();window.addEventListener("resize",onResize,false);diva.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("resize",onResize,false)},settings.ID);if("onorientationchange" in window){window.addEventListener("orientationchange",onResize,false);diva.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("orientationchange",onResize,false)},settings.ID)}diva.Events.subscribe("PanelSizeDidChange",updatePanelSize,settings.ID)};var createButtonElement=function(name,label){var element=document.createElement("span");element.id=settings.ID+name;element.setAttribute("class","diva-"+name+" diva-button");element.title=label;return element};var createViewMenuElement=function(){var viewMenuContainer=document.createElement("div");viewMenuContainer.id=settings.ID+"view-menu";viewMenuContainer.className="diva-view-menu";var viewMenuButton=createButtonElement("view-icon","Change view");viewMenuContainer.appendChild(viewMenuButton);var viewOptionsMenu=document.createElement("div");viewOptionsMenu.id=settings.ID+"view-options";viewOptionsMenu.className="diva-view-options";viewMenuContainer.appendChild(viewOptionsMenu);return viewMenuContainer};var createSliderElement=function(name,value,min,max){var sliderElement=document.createElement("input");sliderElement.id=settings.ID+name;sliderElement.className=name;sliderElement.setAttribute("type","range");sliderElement.setAttribute("value",value);sliderElement.setAttribute("min",min);sliderElement.setAttribute("max",max);return sliderElement};var createLabel=function(name,id,label,innerName,innerValue){var labelContainerElement=document.createElement("div");labelContainerElement.id=settings.ID+id;labelContainerElement.className=name+" diva-label";var zoomLabelNode=document.createTextNode(label);labelContainerElement.appendChild(zoomLabelNode);var innerValueElement=document.createElement("span");innerValueElement.id=settings.ID+innerName;var initialInnerValue=document.createTextNode(innerValue);innerValueElement.appendChild(initialInnerValue);labelContainerElement.appendChild(innerValueElement);return labelContainerElement};var createPageLabel=function(name){var labelContainerElement=document.createElement("span");labelContainerElement.className=name+" diva-label";var labelPrefixNode=document.createTextNode("Page ");var currentPageElement=document.createElement("span");currentPageElement.id=settings.ID+"current-page";var labelMiddleNode=document.createTextNode(" of ");var numPagesElement=document.createElement("span");numPagesElement.id=settings.ID+"num-pages";labelContainerElement.appendChild(labelPrefixNode);labelContainerElement.appendChild(currentPageElement);labelContainerElement.appendChild(labelMiddleNode);labelContainerElement.appendChild(numPagesElement);return labelContainerElement};var createToolbar=function(){var toolbarNode=document.createElement("div");toolbarNode.id=settings.ID+"tools";toolbarNode.className="diva-tools";var divaToolsLeftElement=document.createElement("div");divaToolsLeftElement.id=settings.ID+"tools-left";divaToolsLeftElement.className="diva-tools-left";var divaToolsRightElement=document.createElement("div");divaToolsRightElement.id=settings.ID+"tools-right";divaToolsRightElement.className="diva-tools-right";if(settings.enableZoomControls==="slider"){var zoomControls=createSliderElement("zoom-slider",settings.zoomLevel,settings.minZoomLevel,settings.maxZoomLevel);divaToolsLeftElement.appendChild(zoomControls)}else{if(settings.enableZoomControls==="buttons"){divaToolsLeftElement.appendChild(createButtonElement("zoom-out-button","Zoom Out"));divaToolsLeftElement.appendChild(createButtonElement("zoom-in-button","Zoom In"))}}if(settings.enableGridControls==="slider"){var gridControls=createSliderElement("grid-slider",settings.pagesPerRow,settings.minPagesPerRow,settings.maxPagesPerRow);divaToolsLeftElement.appendChild(gridControls)}else{if(settings.enableGridControls==="buttons"){divaToolsLeftElement.appendChild(createButtonElement("grid-out-button","Zoom Out"));divaToolsLeftElement.appendChild(createButtonElement("grid-in-button","Zoom In"))}}if(settings.enableZoomControls==="slider"||settings.enableZoomControls==="buttons"){var zoomLabel=createLabel("diva-zoom-label","zoom-label","Zoom level: ","zoom-level",settings.zoomLevel);divaToolsLeftElement.appendChild(zoomLabel)}if(settings.enableGridControls==="slider"||settings.enableGridControls==="buttons"){var gridLabel=createLabel("diva-grid-label","grid-label","Pages per row: ","pages-per-row",settings.pagesPerRow);divaToolsLeftElement.appendChild(gridLabel)}var pageNavElement=document.createElement("span");pageNavElement.id=settings.ID+"page-nav";pageNavElement.className="diva-page-nav";var pageLabel=createPageLabel("diva-page-label");pageNavElement.appendChild(pageLabel);if(settings.enableGotoPage){var gotoForm=document.createElement("form");gotoForm.id=settings.ID+"goto-page";gotoForm.className="diva-goto-form";var pageField=document.createElement("input");pageField.id=settings.ID+"goto-page-input";pageField.className="diva-input";pageField.setAttribute("type","text");gotoForm.appendChild(pageField);var pageSubmit=document.createElement("input");pageSubmit.setAttribute("type","submit");pageSubmit.setAttribute("value","Go");gotoForm.appendChild(pageSubmit);pageNavElement.appendChild(gotoForm)}divaToolsRightElement.appendChild(pageNavElement);var viewMenu=createViewMenuElement();divaToolsRightElement.appendChild(viewMenu);if(settings.enableLinkIcon){var linkButton=createButtonElement("link-icon","Link to this page");divaToolsRightElement.appendChild(linkButton)}if(settings.enableFullscreen){var fullscreenButton=createButtonElement("fullscreen-icon","Toggle fullscreen mode");divaToolsRightElement.appendChild(fullscreenButton)}toolbarNode.appendChild(divaToolsLeftElement);toolbarNode.appendChild(divaToolsRightElement);settings.toolbarParentObject.prepend(toolbarNode);var displayViewMenu=function(){var viewOptions=document.createDocumentFragment();var documentIcon=createButtonElement("document-icon","Document View");var bookIcon=createButtonElement("book-icon","Book View");var gridIcon=createButtonElement("grid-icon","Grid View");var viewIcon=document.getElementById(settings.ID+"view-icon");var viewIconClasses=" diva-view-icon diva-button";if(settings.inGrid){viewIcon.className="diva-grid-icon"+viewIconClasses}else{if(settings.inBookLayout){viewIcon.className="diva-book-icon"+viewIconClasses}else{viewIcon.className="diva-document-icon"+viewIconClasses}}if(settings.inGrid||settings.inBookLayout){viewOptions.appendChild(documentIcon)}if(settings.inGrid||!settings.inBookLayout){viewOptions.appendChild(bookIcon)}if(!settings.inGrid){viewOptions.appendChild(gridIcon)}var viewOptionsElement=document.getElementById(settings.ID+"view-options");while(viewOptionsElement.firstChild){viewOptionsElement.removeChild(viewOptionsElement.firstChild)}viewOptionsElement.appendChild(viewOptions)};$(settings.selector+"zoom-slider").on("input",function(e){var intValue=parseInt(this.value,10);handleZoom(intValue)});$(settings.selector+"zoom-slider").on("change",function(e){var intValue=parseInt(this.value,10);if(intValue!==settings.zoomLevel){handleZoom(intValue)}});var zoomButtonClicked=function(direction){handleZoom(settings.zoomLevel+direction)};$(settings.selector+"zoom-out-button").click(function(){zoomButtonClicked(-1)});$(settings.selector+"zoom-in-button").click(function(){zoomButtonClicked(1)});$(settings.selector+"grid-slider").on("input",function(e){var intValue=parseInt(this.value,10);handleGrid(intValue)});$(settings.selector+"grid-slider").on("change",function(e){var intValue=parseInt(this.value,10);if(intValue!==settings.zoomLevel){handleGrid(intValue)}});$(settings.selector+"fullscreen-icon").click(function(){toggleFullscreen()});$(settings.selector+"grid-out-button").click(function(){handleGrid(settings.pagesPerRow-1)});$(settings.selector+"grid-in-button").click(function(){handleGrid(settings.pagesPerRow+1)});$(settings.selector+"view-icon").click(function(){$(settings.selector+"view-options").toggle()});$(settings.selector+"view-options").on("click",".diva-button",function(event){var iconClass=event.target.classList[0];var selectedView;if(iconClass==="diva-document-icon"){selectedView="document"}else{if(iconClass==="diva-book-icon"){selectedView="book"}else{if(iconClass==="diva-grid-icon"){selectedView="grid"}}}diva.Events.publish("UserDidChooseView",[selectedView],self);$(settings.selector+"view-options").hide()});diva.Events.subscribe("UserDidChooseView",changeView,settings.ID);$(document).mouseup(function(event){var container=$(settings.selector+"view-options");if(!container.is(event.target)&&container.has(event.target).length===0&&event.target.id!==settings.ID+"view-icon"){container.hide()}});$(settings.selector+"goto-page").submit(function(){var desiredPage=parseInt($(settings.selector+"goto-page-input").val(),10);var pageIndex=desiredPage-1;if(!isPageValid(pageIndex)){alert("Invalid page number")}else{if(settings.inGrid){gotoRow(pageIndex)}else{gotoPageTop(pageIndex)}}return false});var linkIcon=$(settings.selector+"link-icon");linkIcon.click(function(){$("body").prepend('<div id="'+settings.ID+'link-popup" class="diva-popup diva-link-popup"><input id="'+settings.ID+'link-popup-input" class="diva-input" type="text" value="'+getCurrentURL()+'"/></div>');if(settings.inFullscreen){$(settings.selector+"link-popup").addClass("in-fullscreen")}else{var leftOffset=linkIcon.offset().left-222+linkIcon.outerWidth();var topOffset=linkIcon.offset().top+linkIcon.outerHeight()-1;$(settings.selector+"link-popup").removeClass("in-fullscreen").css({top:topOffset+"px",left:leftOffset+"px"})}$("body").mouseup(function(event){var targetID=event.target.id;if(targetID!==settings.ID+"link-popup"&&targetID!==settings.ID+"link-popup-input"){$(settings.selector+"link-popup").remove()}});settings.outerObject.scroll(function(){$(settings.selector+"link-popup").remove()});$(settings.selector+"link-popup input").click(function(){$(this).focus().select()});return false});var currentSlider=(settings.inGrid)?"grid":"zoom";$(settings.selector+currentSlider+"-slider").css("display","inline-block");$(settings.selector+currentSlider+"-out-button").css("display","inline-block");$(settings.selector+currentSlider+"-in-button").css("display","inline-block");var display=(settings.inFullscreen)?"block":"inline-block";$(settings.selector+currentSlider+"-label").css("display",display);var toolbar={updateCurrentPage:function(){document.getElementById(settings.ID+"current-page").textContent=parseInt(settings.currentPageIndex,10)+1},setNumPages:function(newNumber){document.getElementById(settings.ID+"num-pages").textContent=newNumber},updateZoomLabel:function(){if(settings.enableZoomControls==="slider"&&settings.zoomLevel!==$(settings.selector+"zoom-slider").val()){$(settings.selector+"zoom-slider").val(settings.zoomLevel)}document.getElementById(settings.ID+"zoom-level").textContent=settings.zoomLevel.toString()},updateGridLabel:function(){if(settings.enableGridControls==="slider"&&settings.pagesPerRow!==$(settings.selector+"grid-slider").val()){$(settings.selector+"grid-slider").val(settings.pagesPerRow)}document.getElementById(settings.ID+"pages-per-row").textContent=settings.pagesPerRow},closePopups:function(){$(".diva-popup").css("display","none")},switchView:function(destinationView){$(settings.selector+currentSlider+"-slider").hide();$(settings.selector+currentSlider+"-out-button").hide();$(settings.selector+currentSlider+"-in-button").hide();$(settings.selector+currentSlider+"-label").hide();currentSlider=(settings.inGrid)?"grid":"zoom";$(settings.selector+currentSlider+"-slider").css("display","inline-block");$(settings.selector+currentSlider+"-out-button").css("display","inline-block");$(settings.selector+currentSlider+"-in-button").css("display","inline-block");var display=(settings.inFullscreen)?"block":"inline-block";$(settings.selector+currentSlider+"-label").css("display",display)},switchMode:function(){var toolsRightElement=document.getElementById(settings.ID+"tools-right");var pageNavElement=document.getElementById(settings.ID+"page-nav");var display;if(!settings.inFullscreen){$(settings.selector+"tools").removeClass("diva-fullscreen-tools");toolsRightElement.removeChild(pageNavElement);toolsRightElement.insertBefore(pageNavElement,toolsRightElement.firstChild);currentSlider=(settings.inGrid)?"grid":"zoom";display=(settings.inFullscreen)?"block":"inline-block";$(settings.selector+currentSlider+"-label").css("display",display)}else{$(settings.selector+"tools").addClass("diva-fullscreen-tools");toolsRightElement.removeChild(pageNavElement);toolsRightElement.appendChild(pageNavElement);currentSlider=(settings.inGrid)?"grid":"zoom";display=(settings.inFullscreen)?"block":"inline-block";$(settings.selector+currentSlider+"-label").css("display",display)}},displayViewMenu:displayViewMenu};return toolbar};var initPlugins=function(){if(window.divaPlugins){var pageTools=[];$.each(window.divaPlugins,function(index,plugin){var pluginProperName=plugin.pluginName[0].toUpperCase()+plugin.pluginName.substring(1);if(settings["enable"+pluginProperName]){var enablePlugin=plugin.init(settings,self);if(!enablePlugin){return}var titleText=plugin.titleText||pluginProperName+" plugin";if(typeof plugin.handleClick==="function"){pageTools.push('<div class="diva-'+plugin.pluginName+'-icon" title="'+titleText+'"></div>');var pluginButtonElement=".diva-"+plugin.pluginName+"-icon";settings.outerObject.on("click",pluginButtonElement,function(event){plugin.handleClick.call(this,event,settings,self)});settings.outerObject.on("touchend",pluginButtonElement,function(event){event.preventDefault();plugin.handleClick.call(this,event,settings,self)})}settings.plugins.push(plugin)}});if(pageTools.length){settings.pageTools='<div class="diva-page-tools">'+pageTools.join("")+"</div>"}}};var hideThrobber=function(){clearTimeout(settings.throbberTimeoutID);$(settings.selector+"throbber").hide()};var switchViewState=function(stateObj){var view=stateObj;switch(view){case"d":settings.inGrid=false;settings.inBookLayout=false;break;case"b":settings.inGrid=false;settings.inBookLayout=true;break;case"g":settings.inGrid=true;settings.inBookLayout=false;break}};var parseImageInfo=function(resource){var url=resource["@id"];var fragmentRegex=/#xywh=([0-9]+,[0-9]+,[0-9]+,[0-9]+)/;var xywh="";var stripURL=true;if(/\/([0-9]+,[0-9]+,[0-9]+,[0-9]+)\//.test(url)){var urlArray=url.split("/");xywh=urlArray[urlArray.length-4]}else{if(fragmentRegex.test(url)){var result=fragmentRegex.exec(url);xywh=result[1]}else{if(resource.service&&resource.service["@id"]){url=resource.service["@id"];stripURL=false}}}if(stripURL){url=url.split("/").slice(0,-4).join("/")}var imageInfo={url:url};if(xywh.length){var dimensions=xywh.split(",");imageInfo.x=parseInt(dimensions[0],10);imageInfo.y=parseInt(dimensions[1],10);imageInfo.w=parseInt(dimensions[2],10);imageInfo.h=parseInt(dimensions[3],10)}return imageInfo};var parseManifest=function(manifest){var incorporateZoom=function(imageDimension,zoomDifference){return imageDimension/(Math.pow(2,zoomDifference))};var getMaxZoomLevel=function(width,height){var largestDimension=Math.max(width,height);return Math.ceil(Math.log((largestDimension+1)/(256+1))/Math.log(2))};var initializeArrayWithValue=function(array,value){var i=array.length;while(i--){array[i]=value}};diva.Events.publish("ManifestDidLoad",[manifest],self);var sequence=manifest.sequences[0];settings.documentPaged=manifest.viewingHint==="paged"||sequence.viewingHint==="paged";var canvases=sequence.canvases;var zoomLevels=new Array(canvases.length);var images=new Array(canvases.length);var width;var height;var url;var info;var maxZoom;var label;var context;var resource;var imageAPIVersion;var title=manifest.label;for(var i=0,numCanvases=canvases.length;i<numCanvases;i++){resource=canvases[i].images[0].resource;width=resource.width||canvases[i].width;height=resource.height||canvases[i].height;info=parseImageInfo(resource);url=info.url;if(url.slice(-1)!=="/"){url=url+"/"}maxZoom=getMaxZoomLevel(width,height);label=canvases[i].label;var paged=canvases[i].viewingHint!=="non-paged";context=resource.service["@context"];if(context==="http://iiif.io/api/image/2/context.json"){imageAPIVersion=2}else{if(context==="http://library.stanford.edu/iiif/image-api/1.1/context.json"){imageAPIVersion=1.1}else{imageAPIVersion=1}}images[i]={mx_w:width,mx_h:height,mx_z:maxZoom,fn:label,url:url,api:imageAPIVersion,paged:paged};if(info.hasOwnProperty("x")){images[i].xoffset=info.x;images[i].yoffset=info.y}zoomLevels[i]=maxZoom}var lowestMaxZoom=Math.min.apply(Math,zoomLevels);var maxRatio=0;var minRatio=100;var totalWidths=new Array(lowestMaxZoom+1);var totalHeights=new Array(lowestMaxZoom+1);var maxWidths=new Array(lowestMaxZoom+1);var maxHeights=new Array(lowestMaxZoom+1);var totalHeightsPaged=new Array(lowestMaxZoom+1);initializeArrayWithValue(totalWidths,0);initializeArrayWithValue(totalHeights,0);initializeArrayWithValue(maxWidths,0);initializeArrayWithValue(maxHeights,0);initializeArrayWithValue(totalHeightsPaged,0);var pages=[];var currentPageZoomData;var widthAtCurrentZoomLevel;var heightAtCurrentZoomLevel;var numImages=images.length;for(i=0;i<numImages;i++){currentPageZoomData=[];for(var j=0;j<lowestMaxZoom+1;j++){widthAtCurrentZoomLevel=Math.floor(incorporateZoom(images[i].mx_w,lowestMaxZoom-j));heightAtCurrentZoomLevel=Math.floor(incorporateZoom(images[i].mx_h,lowestMaxZoom-j));currentPageZoomData[j]={h:heightAtCurrentZoomLevel,w:widthAtCurrentZoomLevel};totalWidths[j]+=widthAtCurrentZoomLevel;totalHeights[j]+=heightAtCurrentZoomLevel;maxWidths[j]=Math.max(widthAtCurrentZoomLevel,maxWidths[j]);maxHeights[j]=Math.max(heightAtCurrentZoomLevel,maxHeights[j]);var ratio=images[i].mx_h/images[i].mx_w;maxRatio=Math.max(ratio,maxRatio);minRatio=Math.min(ratio,minRatio)}pages[i]={d:currentPageZoomData,m:images[i].mx_z,f:images[i].fn,url:images[i].url,api:images[i].api,paged:images[i].paged};if(images[i].hasOwnProperty("xoffset")){pages[i].xoffset=images[i].xoffset;pages[i].yoffset=images[i].yoffset}}var averageWidths=[];var averageHeights=[];for(i=0;i<lowestMaxZoom+1;i++){averageWidths.push(totalWidths[i]/images.length);averageHeights.push(totalHeights[i]/images.length)}var dims={a_wid:averageWidths,a_hei:averageHeights,max_w:maxWidths,max_h:maxHeights,max_ratio:maxRatio,min_ratio:minRatio,t_hei:totalHeights,t_wid:totalWidths};var divaServiceBlock={item_title:title,dims:dims,max_zoom:lowestMaxZoom,pgs:pages};return divaServiceBlock};var ajaxError=function(jqxhr,status,error){hideThrobber();var requestError='<div id="'+settings.ID+'error" class="diva-error"><p><strong>Error</strong></p><p>Invalid objectData. Error code: '+status+" "+error+"</p>";var dataHasAbsolutePath=settings.objectData.lastIndexOf("http",0)===0;if(dataHasAbsolutePath&&error===""){var jsonHost=settings.objectData.replace(/https?:\/\//i,"").split(/[/?#]/)[0];if(location.hostname!==jsonHost){requestError+='<p>Attempted to access cross-origin data without CORS.</p><p>You may need to update your server configuration to support CORS. For help, see the <a href="https://github.com/DDMAL/diva.js/wiki/Installation#a-note-about-cross-site-requests" target="_blank">cross-site request documentation.</a></p>'}}requestError+="</div>";settings.outerObject.append(requestError)};var loadObjectData=function(data){parseObjectData(data);diva.Events.publish("ObjectDidLoad",[settings],self);updatePanelSize();var yParam=parseInt($.getHashParam("y"+settings.hashParamSuffix),10);if(!isNaN(yParam)){settings.verticalOffset=yParam}else{settings.verticalOffset=getYOffset(settings.currentPageIndex,"top")}var xParam=parseInt($.getHashParam("x"+settings.hashParamSuffix),10);if(!isNaN(xParam)){settings.horizontalOffset=xParam}else{if(settings.goDirectlyTo===0&&settings.inBookLayout&&settings.verticallyOriented){settings.horizontalOffset=0+settings.horizontalPadding}else{settings.horizontalOffset=getXOffset(settings.currentPageIndex,"center")}}if(settings.inFullscreen){handleModeChange(false)}else{loadViewer()}updatePanelSize();diva.Events.publish("ViewerDidLoad",[settings],self);settings.loaded=true};var parseObjectData=function(responseData){var data;if(responseData.hasOwnProperty("@context")&&(responseData["@context"].indexOf("iiif")!==-1||responseData["@context"].indexOf("shared-canvas")!==-1)){settings.isIIIF=true;data=parseManifest(responseData)}else{data=responseData}hideThrobber();settings.pages=data.pgs;settings.maxRatio=data.dims.max_ratio;settings.minRatio=data.dims.min_ratio;settings.itemTitle=data.item_title;settings.numPages=data.pgs.length;settings.maxWidths=data.dims.max_w;settings.maxHeights=data.dims.max_h;settings.averageWidths=data.dims.a_wid;settings.averageHeights=data.dims.a_hei;settings.totalHeights=data.dims.t_hei;settings.totalWidths=data.dims.t_wid;settings.realMaxZoom=data.max_zoom;settings.maxZoomLevel=(settings.maxZoomLevel>=0&&settings.maxZoomLevel<=data.max_zoom)?settings.maxZoomLevel:data.max_zoom;settings.minZoomLevel=(settings.minZoomLevel>=0&&settings.minZoomLevel<=settings.maxZoomLevel)?settings.minZoomLevel:0;settings.zoomLevel=getValidZoomLevel(settings.zoomLevel);settings.minPagesPerRow=Math.max(2,settings.minPagesPerRow);settings.maxPagesPerRow=Math.max(settings.minPagesPerRow,settings.maxPagesPerRow);if(settings.enableFilename){var iParam=$.getHashParam("i"+settings.hashParamSuffix);var iParamPage=getPageIndex(iParam);if(isPageValid(iParamPage)){settings.goDirectlyTo=iParamPage;settings.currentPageIndex=iParamPage}}else{var pParam=parseInt($.getHashParam("p"+settings.hashParamSuffix),10)-1;if(isPageValid(pParam)){settings.goDirectlyTo=pParam;settings.currentPageIndex=pParam}}diva.Events.publish("NumberOfPagesDidChange",[settings.numPages],self);if(settings.enableAutoTitle){if($(settings.selector+"title").length){$(settings.selector+"title").html(settings.itemTitle)}else{settings.parentObject.prepend('<div id="'+settings.ID+'title" class="diva-title">'+settings.itemTitle+"</div>")}}if(!isPageValid(parseInt(settings.goDirectlyTo),10)){settings.goDirectlyTo=0}if(settings.adaptivePadding>0){var z=settings.zoomLevel;settings.horizontalPadding=parseInt(settings.averageWidths[z]*settings.adaptivePadding,10);settings.verticalPadding=parseInt(settings.averageHeights[z]*settings.adaptivePadding,10)}else{settings.horizontalPadding=settings.fixedPadding;settings.verticalPadding=settings.fixedPadding}if(settings.pageTools.length){settings.verticalPadding=Math.max(40,settings.verticalPadding)}if(settings.documentPaged){settings.inBookLayout=true}var viewParam=$.getHashParam("v"+settings.hashParamSuffix);switchViewState(viewParam)};var setupViewer=function(){if(typeof settings.objectData==="object"){setTimeout(function(){loadObjectData(settings.objectData)},0);return}settings.throbberTimeoutID=setTimeout(function(){$(settings.selector+"throbber").show()},settings.throbberTimeout);$.ajax({url:settings.objectData,cache:false,dataType:"json",error:ajaxError,success:loadObjectData})};var checkLoaded=function(){if(!settings.loaded){console.warn("The viewer is not completely initialized. This is likely because it is still downloading data. To fix this, only call this function if the isReady() method returns true.");return false}return true};var init=function(){settings.scrollbarWidth=$.getScrollbarWidth();settings.mobileWebkit=window.orientation!==undefined;settings.ID=$.generateId("diva-");settings.selector="#"+settings.ID;var divaNumber=parseInt(settings.ID,10);if(divaNumber>1){settings.hashParamSuffix=divaNumber}settings.parentObject.append('<div id="'+settings.ID+'outer" class="diva-outer"></div>');settings.outerObject=$(settings.selector+"outer");settings.outerObject.append('<div id="'+settings.ID+'inner" class="diva-inner diva-dragger"></div>');settings.innerObject=$(settings.selector+"inner");settings.outerObject.append('<div id="'+settings.ID+'throbber" class="diva-throbber"></div>');var nParam=parseInt($.getHashParam("n"+settings.hashParamSuffix),10);if(nParam>=settings.minPagesPerRow&&nParam<=settings.maxPagesPerRow){settings.pagesPerRow=nParam}var zParam=$.getHashParam("z"+settings.hashParamSuffix);if(zParam!==""){zParam=parseInt(zParam,10);if(zParam>=settings.minZoomLevel){settings.zoomLevel=zParam}}if(settings.enableToolbar){settings.toolbar=createToolbar();diva.Events.subscribe("VisiblePageDidChange",settings.toolbar.updateCurrentPage,settings.ID);diva.Events.subscribe("ModeDidSwitch",settings.toolbar.switchMode,settings.ID);diva.Events.subscribe("ViewDidSwitch",settings.toolbar.switchView,settings.ID);diva.Events.subscribe("ViewDidSwitch",settings.toolbar.displayViewMenu,settings.ID);diva.Events.subscribe("ZoomLevelDidChange",settings.toolbar.updateZoomLabel,settings.ID);diva.Events.subscribe("GridRowNumberDidChange",settings.toolbar.updateGridLabel,settings.ID);diva.Events.subscribe("NumberOfPagesDidChange",settings.toolbar.setNumPages,settings.ID);diva.Events.subscribe("ObjectDidLoad",settings.toolbar.displayViewMenu,settings.ID);diva.Events.subscribe("ObjectDidLoad",settings.toolbar.switchView,settings.ID);diva.Events.subscribe("ObjectDidLoad",function(){settings.toolbar.setNumPages(settings.numPages)},settings.ID);diva.Events.subscribe("ViewerDidLoad",settings.toolbar.switchMode,settings.ID);diva.Events.subscribe("ViewerDidLoad",function(){settings.toolbar.updateCurrentPage(settings.currentPageIndex)},settings.ID);diva.Events.subscribe("ViewerDidLoad",function(){settings.toolbar.updateZoomLabel(settings.zoomLevel)},settings.ID)}var fullscreenParam=$.getHashParam("f"+settings.hashParamSuffix);var goIntoFullscreen=fullscreenParam==="true";settings.inFullscreen=(settings.inFullscreen&&fullscreenParam!=="false")||goIntoFullscreen;setupViewer();initPlugins();handleEvents()};init();this.getItemTitle=function(){return settings.itemTitle};this.gotoPageByNumber=function(pageNumber,xAnchor,yAnchor){var pageIndex=parseInt(pageNumber,10)-1;if(isPageValid(pageIndex)){gotoPage(pageIndex,getYOffset(pageIndex,yAnchor),getXOffset(pageIndex,xAnchor));return true}return false};this.gotoPageByIndex=function(pageIndex,xAnchor,yAnchor){pageIndex=parseInt(pageIndex,10);if(isPageValid(pageIndex)){gotoPage(pageIndex,getYOffset(pageIndex,yAnchor),getXOffset(pageIndex,xAnchor));return true}return false};this.getNumberOfPages=function(){if(!checkLoaded()){return false}return settings.numPages};this.getPageDimensionsAtZoomLevel=function(pageIdx,zoomLevel){if(!checkLoaded()){return false}if(zoomLevel>settings.maxZoomLevel){zoomLevel=settings.maxZoomLevel}var pg=settings.pages[parseInt(pageIdx,10)];var pgAtZoom=pg.d[parseInt(zoomLevel,10)];return{width:pgAtZoom.w,height:pgAtZoom.h}};this.getCurrentPageDimensionsAtCurrentZoomLevel=function(){return this.getPageDimensionsAtZoomLevel(settings.currentPageIndex,settings.zoomLevel)};this.isReady=function(){return settings.loaded};this.getCurrentPageIndex=function(){return settings.currentPageIndex};this.getCurrentPageFilename=function(){return settings.pages[settings.currentPageIndex].f};this.getCurrentPageNumber=function(){return settings.currentPageIndex+1};this.getFilenames=function(){var filenames=[];for(var i=0;i<settings.numPages;i++){filenames[i]=settings.pages[i].f}return filenames};this.getZoomLevel=function(){return settings.zoomLevel};this.getMaxZoomLevel=function(){return settings.maxZoomLevel};this.getMaxZoomLevelForPage=function(pageIdx){if(!checkLoaded){return false}return settings.pages[pageIdx].m};this.getMinZoomLevel=function(){return settings.minZoomLevel};this.setZoomLevel=function(zoomLevel){if(settings.inGrid){settings.goDirectlyTo=settings.currentPageIndex;settings.inGrid=false;handleViewChange()}return handleZoom(zoomLevel)};this.zoomIn=function(){return this.setZoomLevel(settings.zoomLevel+1)};this.zoomOut=function(){return this.setZoomLevel(settings.zoomLevel-1)};this.inViewport=function(pageNumber,leftOffset,topOffset,width,height){var pageIndex=pageNumber-1;var top=settings.pageTopOffsets[pageIndex]+topOffset;var bottom=top+height;var left=settings.pageLeftOffsets[pageIndex]+leftOffset;var right=left+width;return isVerticallyInViewport(top,bottom)&&isHorizontallyInViewport(left,right)};this.isPageInViewport=function(pageIndex){return isPageVisible(pageIndex)};this.isPageLoaded=function(pageIndex){return isPageLoaded(pageIndex)};this.toggleFullscreenMode=function(){toggleFullscreen()};this.closePopups=function(){settings.toolbar.closePopups()};this.enterFullscreenMode=function(){if(!settings.inFullscreen){toggleFullscreen();return true}return false};this.leaveFullscreenMode=function(){if(settings.inFullscreen){toggleFullscreen();return true}return false};this.changeView=function(destinationView){return changeView(destinationView)};this.enterGridView=function(){if(!settings.inGrid){changeView("grid");return true}return false};this.leaveGridView=function(){if(settings.inGrid){settings.goDirectlyTo=settings.currentPageIndex;settings.inGrid=false;handleViewChange();return true}return false};this.gotoPageByName=function(filename,xAnchor,yAnchor){var pageIndex=getPageIndex(filename);if(isPageValid(pageIndex)){gotoPage(pageIndex,getYOffset(pageIndex,yAnchor),getXOffset(pageIndex,xAnchor));return true}return false};this.getPageIndex=function(filename){return getPageIndex(filename)};this.getCurrentURL=function(){return getCurrentURL()};this.getURLHash=function(){return getURLHash()};this.getState=function(){return getState()};this.getInstanceSelector=function(){return settings.selector};this.getInstanceId=function(){return settings.ID};this.getSettings=function(){return settings};this.translateFromMaxZoomLevel=function(position){var zoomDifference=settings.maxZoomLevel-settings.zoomLevel;return position/Math.pow(2,zoomDifference)};this.translateToMaxZoomLevel=function(position){var zoomDifference=settings.maxZoomLevel-settings.zoomLevel;if(zoomDifference===0){return position}return position*Math.pow(2,zoomDifference)};this.setState=function(state){var pageIndex;pageIndex=getPageIndex(state.i);if(isPageValid(pageIndex)){settings.goDirectlyTo=pageIndex}else{if(isPageValid(state.p)){settings.goDirectlyTo=state.p}}var horizontalOffset=parseInt(state.x,10);var verticalOffset=parseInt(state.y,10);if(state.z>=settings.minZoomLevel&&state.z<=settings.maxZoomLevel){settings.zoomLevel=state.z}if(state.n>=settings.minPagesPerRow&&state.n<=settings.maxPagesPerRow){settings.pagesPerRow=state.n}if(settings.inFullscreen!==state.f){switchViewState(state.v);settings.inFullscreen=state.f;handleModeChange(false);settings.horizontalOffset=horizontalOffset;settings.verticalOffset=verticalOffset;gotoPage(pageIndex,settings.verticalOffset,settings.horizontalOffset)}else{settings.horizontalOffset=horizontalOffset;settings.verticalOffset=verticalOffset;if((state.v==="g"&&(!settings.inGrid||settings.inBookLayout))||(state.v==="d"&&(settings.inGrid||settings.inBookLayout))||(state.v==="b"&&!settings.inBookLayout)){switchViewState(state.v);handleViewChange()}else{loadViewer()}}};this.enableScrollable=function(){if(!settings.isScrollable){bindMouseEvents();settings.enableKeyScroll=settings.initialKeyScroll;settings.enableSpaceScroll=settings.initialSpaceScroll;settings.outerObject.css("overflow","auto");settings.isScrollable=true}};this.disableScrollable=function(){if(settings.isScrollable){if(settings.innerObject.hasClass("diva-dragger")){settings.innerObject.unbind("mousedown")}settings.outerObject.unbind("dblclick");settings.outerObject.unbind("contextmenu");settings.outerObject.css("overflow","hidden");settings.initialKeyScroll=settings.enableKeyScroll;settings.initialSpaceScroll=settings.enableSpaceScroll;settings.enableKeyScroll=false;settings.enableSpaceScroll=false;settings.isScrollable=false}};this.toggleOrientation=function(){return toggleOrientation()};this.getPageOffset=function(pageIndex){return{top:parseInt(settings.pageTopOffsets[pageIndex]),left:parseInt(settings.pageLeftOffsets[pageIndex])}};this.getCurrentPageOffset=function(){return this.getPageOffset(settings.currentPageIndex)};this.getPageDimensionsAtCurrentGridLevel=function(pageIndex){pageIndex=(isPageValid(pageIndex)?pageIndex:settings.currentPageIndex);var pageHeight=settings.rowHeight-settings.fixedPadding;var pageWidth=(settings.fixedHeightGrid)?(settings.rowHeight-settings.fixedPadding)*getPageData(pageIndex,"w")/getPageData(pageIndex,"h"):settings.gridPageWidth;return{height:parseInt(pageHeight,10),width:parseInt(pageWidth,10)}};this.getPageIndexForPageXYValues=function(pageX,pageY){var outerObj=document.getElementById(settings.ID+"outer");var outerOffset=outerObj.getBoundingClientRect();var outerTop=outerOffset.top;var outerLeft=outerOffset.left;var outerBottom=outerOffset.bottom;var outerRight=outerOffset.right;if(pageX<outerLeft||pageX>outerRight){return false}if(pageY<outerTop||pageY>outerBottom){return false}var pages=document.getElementsByClassName("diva-page");var curPageIdx=pages.length;while(curPageIdx--){var curPage=pages[curPageIdx];var curOffset=curPage.getBoundingClientRect();if(pageX<curOffset.left||pageX>curOffset.right){continue}if(pageY<curOffset.top||pageY>curOffset.bottom){continue}return curPage.getAttribute("data-index")}return false};this.isVerticallyOriented=function(){return settings.verticallyOriented};this.changeObject=function(objectData){settings.loaded=false;clearViewer();settings.objectData=objectData;if(typeof objectData==="object"){setTimeout(function(){parseObjectData(objectData);loadViewer();settings.loaded=true});return}settings.throbberTimeoutID=setTimeout(function(){$(settings.selector+"throbber").show()},settings.throbberTimeout);$.ajax({url:settings.objectData,cache:true,dataType:"json",error:ajaxError,success:function(responseData,status,jqxhr){parseObjectData(responseData);hideThrobber();loadViewer();settings.loaded=true}})};this.activate=function(){settings.isActiveDiva=true};this.deactivate=function(){settings.isActiveDiva=false};this.destroy=function(){$("body").removeClass("diva-hide-scrollbar");settings.parentObject.empty().removeData("diva");diva.Events.publish("ViewerDidTerminate",[settings],self);settings.parentObject.removeAttr("style").removeAttr("class");diva.Events.unsubscribeAll(settings.ID)}};$.fn.diva=function(options){return this.each(function(){var divaParent=$(this);if(divaParent.data("diva")){return}var diva=new Diva(this,options);divaParent.data("diva",diva)})}})(jQuery);